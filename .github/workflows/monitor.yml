name: Website Monitor

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 mins
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Monitor & Notify
        env:
          SECRETS_JSON: ${{ toJson(secrets) }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # --- CONFIGURATION ---
          QUIET_MODE: "false"      # Set "true" to ONLY notify on errors (no 30-min spam)
          MAX_LATENCY: 2000        # Alert if slower than 2s
          MIN_SIZE: 200            # Alert if page < 200 bytes
          USER_AGENT: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
        run: |
          # 1. RUNNER HEALTH CHECK (Prevent False Alarms)
          # If the GitHub runner itself has no internet, we exit quietly.
          if ! curl -s --head  --request GET "https://1.1.1.1" --connect-timeout 5 > /dev/null; then
             echo "âš ï¸ GitHub Runner has no internet. Skipping checks."
             exit 0
          fi

          # Setup Dashboard
          echo "### ðŸš€ Monitor Results ($(date -u))" >> $GITHUB_STEP_SUMMARY
          echo "| Site | Status | Latency | Size | SSL |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          TG_REPORT="ðŸ” *Website Monitor Report* %0A%0A"
          
          # Extract URLS from Secrets
          URLS=$(echo '$SECRETS_JSON' | jq -r 'to_entries[] | select(.key | startswith("SITE_")) | "\(.key)|\(.value)"')
          
          while IFS="|" read -r NAME URL; do
            NICKNAME=${NAME#SITE_}
            SUCCESS=false
            FINAL_CODE="000"
            FINAL_SIZE=0
            FINAL_LATENCY=0
            PERF_WARNING=false
            
            # --- CHECK LOGIC (3 Retries) ---
            for i in {1..3}; do
              RES=$(curl -A "$USER_AGENT" -L -s -o /dev/null -w "%{http_code}|%{time_total}|%{size_download}" --connect-timeout 10 "$URL" || echo "000|0|0")
              CODE=$(echo "$RES" | cut -d'|' -f1)
              LAT_SEC=$(echo "$RES" | cut -d'|' -f2)
              SIZE=$(echo "$RES" | cut -d'|' -f3)
              LAT_MS=$(echo "$LAT_SEC * 1000 / 1" | bc)

              if [[ "$CODE" =~ ^2 ]] && [ "$SIZE" -gt "$MIN_SIZE" ]; then
                SUCCESS=true
                FINAL_CODE=$CODE; FINAL_SIZE=$SIZE; FINAL_LATENCY=$LAT_MS
                break
              fi
              FINAL_CODE=$CODE; FINAL_SIZE=$SIZE; FINAL_LATENCY=$LAT_MS
              sleep 5
            done

            # --- PERFORMANCE & SSL LOGIC ---
            if [ "$SUCCESS" = true ] && [ "$FINAL_LATENCY" -gt "$MAX_LATENCY" ]; then
                PERF_WARNING=true
                curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                  -d chat_id="${TG_CHAT_ID}" -d parse_mode="Markdown" \
                  -d text="ðŸŒ *PERF WARNING:* ${NICKNAME} is slow! (${FINAL_LATENCY}ms)"
            fi

            DOMAIN=$(echo "$URL" | awk -F[/:] '{print $4}')
            SSL_ICON="ðŸ›¡ï¸"
            EXP_DATE=$(echo | openssl s_client -connect "${DOMAIN}:443" -servername "${DOMAIN}" 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
            if [ -n "$EXP_DATE" ]; then
                EXP_S=$(date -d "$EXP_DATE" +%s); NOW_S=$(date +%s)
                DAYS_LEFT=$(( ($EXP_S - $NOW_S) / 86400 ))
                if [ "$DAYS_LEFT" -lt 14 ]; then
                   SSL_ICON="âš ï¸"
                   # Always alert on SSL expiry
                   curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                     -d chat_id="${TG_CHAT_ID}" -d parse_mode="Markdown" \
                     -d text="ðŸ”’ *SSL WARNING:* ${NICKNAME} expires in ${DAYS_LEFT} days!"
                fi
            fi

            # --- REPORTING ---
            SIZE_DISPLAY="$(echo "scale=1; $FINAL_SIZE / 1024" | bc)KB"

            if [ "$SUCCESS" = true ]; then
              STATUS="âœ… UP"
              [ "$PERF_WARNING" = true ] && SPEED_ICON="ðŸ¢" || { [ "$FINAL_LATENCY" -lt 500 ] && SPEED_ICON="ðŸš€" || SPEED_ICON="ðŸŸ¡"; }
              
              echo "| $NICKNAME | $STATUS | ${FINAL_LATENCY}ms | $SIZE_DISPLAY | $SSL_ICON |" >> $GITHUB_STEP_SUMMARY
              TG_REPORT="${TG_REPORT}*${NICKNAME}*: ${STATUS} (${FINAL_LATENCY}ms) ${SPEED_ICON}%0A"
            else
              STATUS="âŒ FAIL"
              [ "$FINAL_SIZE" -le "$MIN_SIZE" ] && ERR="Blank/Broken (Size: ${FINAL_SIZE}b)" || ERR="HTTP $FINAL_CODE"
              echo "| $NICKNAME | $STATUS | - | ${FINAL_SIZE}b | $SSL_ICON |" >> $GITHUB_STEP_SUMMARY
              
              # CRITICAL ALERT (Always sent)
              ALERT_MSG="ðŸš¨ *CRITICAL ALERT* %0A%0A*${NICKNAME}* failed! %0AReason: ${ERR} %0A%0A [View Logs](${RUN_URL})"
              curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                -d chat_id="${TG_CHAT_ID}" -d parse_mode="Markdown" -d text="${ALERT_MSG}"
            fi
            
          done <<< "$URLS"

          # Send Summary Report (Only if Quiet Mode is FALSE)
          if [ "$QUIET_MODE" = "false" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT_ID}" -d parse_mode="Markdown" -d text="${TG_REPORT}"
          fi
