name: Website Monitor

on:
  schedule:
    - cron: '*/30 * * * *' # Runs every 30 mins
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Monitor & Notify
        env:
          SECRETS_JSON: ${{ toJson(secrets) }}
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          
          # --- CONFIGURATION ---
          MAX_LATENCY: 2000 # Alert if slower than 2 seconds
          MIN_SIZE: 100     # Alert if page is blank (less than 100 bytes)
          USER_AGENT: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
        run: |
          # 1. RUNNER HEALTH CHECK
          if ! curl -s --head --request GET "https://1.1.1.1" --connect-timeout 5 > /dev/null; then
             echo "‚ö†Ô∏è GitHub Runner has no internet. Skipping checks."
             exit 0
          fi

          # 2. SET TIME TO IST (Asia/Kolkata)
          # We use the TZ variable to force the date command into IST
          CURRENT_TIME=$(TZ='Asia/Kolkata' date +'%d-%b %H:%M IST')
          
          # Initialize Report
          FINAL_MSG="üìä *Website Status Report* %0AüìÖ ${CURRENT_TIME}%0A%0A"
          
          # Parse Secrets
          URLS=$(echo "$SECRETS_JSON" | jq -r 'to_entries[] | select(.key | startswith("SITE_")) | "\(.key)|\(.value)"')
          
          while IFS="|" read -r NAME URL; do
            NICKNAME=${NAME#SITE_}
            SUCCESS=false
            FINAL_CODE="000"
            FINAL_SIZE=0
            FINAL_LATENCY=0
            
            # --- CHECK LOGIC (3 Retries) ---
            for i in {1..3}; do
              RES=$(curl -A "$USER_AGENT" -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" -H "Accept-Language: en-US,en;q=0.5" -L -s -o /dev/null -w "%{http_code}|%{time_total}|%{size_download}" --connect-timeout 15 "$URL" || echo "000|0|0")
              
              CODE=$(echo "$RES" | cut -d'|' -f1)
              LAT_SEC=$(echo "$RES" | cut -d'|' -f2)
              SIZE=$(echo "$RES" | cut -d'|' -f3)
              LAT_MS=$(echo "$LAT_SEC * 1000 / 1" | bc)

              if [[ "$CODE" =~ ^2 ]] && [ "$SIZE" -gt "$MIN_SIZE" ]; then
                SUCCESS=true
                FINAL_CODE=$CODE; FINAL_SIZE=$SIZE; FINAL_LATENCY=$LAT_MS
                break
              fi
              
              FINAL_CODE=$CODE; FINAL_SIZE=$SIZE; FINAL_LATENCY=$LAT_MS
              sleep 5
            done

            # --- SSL CHECK ---
            SSL_WARNING=""
            DOMAIN=$(echo "$URL" | awk -F[/:] '{print $4}')
            EXP_DATE=$(echo | openssl s_client -connect "${DOMAIN}:443" -servername "${DOMAIN}" 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
            if [ -n "$EXP_DATE" ]; then
                EXP_S=$(date -d "$EXP_DATE" +%s); NOW_S=$(date +%s)
                DAYS_LEFT=$(( ($EXP_S - $NOW_S) / 86400 ))
                if [ "$DAYS_LEFT" -lt 14 ]; then
                   SSL_WARNING=" [SSL: ${DAYS_LEFT} days!]"
                fi
            fi

            # --- BUILD REPORT LINE ---
            if [ "$SUCCESS" = true ]; then
              if [ "$FINAL_LATENCY" -gt "$MAX_LATENCY" ]; then
                ICON="üê¢"
                DETAILS="${FINAL_LATENCY}ms (Slow)"
              else
                ICON="‚úÖ"
                DETAILS="${FINAL_LATENCY}ms"
              fi
              FINAL_MSG="${FINAL_MSG}${ICON} *${NICKNAME}*: ${DETAILS}${SSL_WARNING}%0A"
            else
              # --- SITE DOWN ---
              if [ "$FINAL_SIZE" -le "$MIN_SIZE" ]; then REASON="Blank Page"; else REASON="Error $FINAL_CODE"; fi
              FINAL_MSG="${FINAL_MSG}üî¥ *${NICKNAME}*: DOWN (${REASON})%0A"
              
              # Immediate Critical Alert (Simple format)
              curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                -d chat_id="${TG_CHAT_ID}" \
                -d parse_mode="Markdown" \
                -d text="üö® *${NICKNAME} is DOWN!* %0AStatus: ${REASON}%0AURL: ${URL}"
            fi
            
          done <<< "$URLS"

          # --- SEND FINAL REPORT ---
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${FINAL_MSG}"
